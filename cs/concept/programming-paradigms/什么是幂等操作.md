## 1. 概述

在本文中，我们将了解什么是幂等操作，幂等性为何有用，我们还将了解 REST 中的幂等性。

## 2.什么是幂等性？

简单地说，我们可以多次执行幂等操作而不改变结果。

此外，该操作在第一次成功执行后不得产生任何副作用。

让我们看两个简单的例子。

### 2.1. 绝对值

返回绝对值的函数是幂等的；无论我们将它应用于同一个数字的频率如何，它总是返回相同的结果。

让我们考虑一下函数：

![a(x) = |x|](https://www.baeldung.com/wp-content/ql-cache/quicklatex.com-575fab00476929e47d19dfa237019ed2_l3.svg)

那么以下内容为真：

![a(a(x)) = a(x)](https://www.baeldung.com/wp-content/ql-cache/quicklatex.com-ca3e22f9db0ac3b0124fcf09c7acaddd_l3.svg)

例子：

![a(-42) = a(a(-42)) = 42](https://www.baeldung.com/wp-content/ql-cache/quicklatex.com-a287b4f7c9705df6a096c0c3a70c517a_l3.svg)

相反，翻转数字符号的函数不是幂等的：

![b(x) = -x](https://www.baeldung.com/wp-content/ql-cache/quicklatex.com-0e6eb4c75fcac7c91f07174893c67de2_l3.svg)

然后：

![b(b(x)) ne b(x)](https://www.baeldung.com/wp-content/ql-cache/quicklatex.com-c386ceed917bedd283c2844212ef46cd_l3.svg)

例子：

![b(-42) = 42 ne a(a(-42))](https://www.baeldung.com/wp-content/ql-cache/quicklatex.com-e6e142b47fb733ebbb67b04a9672cd7a_l3.svg)

### 2.2. 更新地址

幂等操作的另一个实际示例是更新系统中用户的详细联系信息。假设我们只更新电话号码。本次更新带来的副作用是，我们向新号码发送了一条带有验证码的短信。我们有三种可能的情况：

-   第一次更新消息处理成功，系统更新了号码，发送了短信。再次发送更新消息时，将不会发生任何事情。此外，不会第二次发送短信。
-   第一次更新失败。系统没有更新，也没有发送短信。如果第二次更新成功，则更新系统，并发送短信。
-   第一次更新失败。在发送另一个更新之前，用户在系统中被停用。由于系统状态已更改，因此电话号码的第二次更新不会影响。

## 3. 为什么要幂等？

幂等性确保相同的请求导致相同的系统状态，并且不会无意中多次执行任何操作。

例如，让我们看一下发送方S通过支付服务PS向接收方R 汇款的请求。

### 3.1. 不相同的例子

这是请求的非幂等版本：

![幂等性2](https://www.baeldung.com/wp-content/uploads/sites/4/2020/09/Idempotency-2-1536x1120-1-1024x747.png)

在第一次尝试中，S发送了一个向R发送 10 美元的请求。PS接收消息；但是，实际传输失败了。PS向 S 发送错误消息，S由于网络故障没有收到该消息。

S不知道转账是否成功，于是又试了一次。这次向R转账成功，PS向S发送确认信息。同样，确认失败，S不知道转账成功与否。

于是，他第三次尝试。PS收到消息，将其视为新的请求，将钱发送给 R，并向S返回确认。

这不是幂等请求，因为我们打算重试相同的付款而不是发送两次。

### 3.2. 幂等键

支付是说明为什么幂等性有用的一个很好的例子。在前面的示例中，我们已经看到向R 的付款被执行了多次，因为S在不知道转账已经成功的情况下退休了。

如果操作是幂等的，就不会是这样了。但是PS如何知道S刚刚重试了相同的付款并且不想向S发送第二次 10 美元的付款？

为了实现这一点，S在他对PS的请求中包含一个幂等键。例如，此密钥可以是 [UUID](https://www.baeldung.com/java-uuid)。如果PS收到具有相同幂等键的请求，它就知道这是一次重试。如果它之前没有见过密钥，它就知道这是一个新请求。

让我们看一下上一个例子的幂等版本：

![幂等性 3](https://www.baeldung.com/wp-content/uploads/sites/4/2020/09/Idempotency-3-1536x1142-1-1024x761.png)

在这里，第一次尝试和第一次重试与非幂等版本中的相同，只是请求包含幂等密钥(在我们的示例中为65TH68M5)。

重要的区别在于第二次重试： PS收到消息，发现一条具有相同幂等键的消息已经处理成功，并向S返回一个确认，而没有再次将钱发送给R。

在这里，幂等性的好处是S可以根据需要重试多次，而不必担心重复支付。 PS不需要担心S收到确认消息，因为他知道如果S没有收到消息， S可以重试。

这种方法的缺点是PS需要存储所有收到的密钥。如果请求不多，这可能没问题；但是，如果请求频率非常高，则可能会出现问题。一种解决方案是在一段时间后使幂等密钥过期。

## 4.幂等性和REST

### 4.1. 概述

让我们简要了解一下幂等性如何应用于 HTTP 动词，当我们想要构建 REST API 时，了解这些动词很重要。[在RFC 7231](https://tools.ietf.org/html/rfc7231)中可以找到所有 HTTP 谓词的非常详细的参考。

下表显示了哪些动词是(或应该是)幂等的。

![由 QuickLaTeX.com 呈现](https://www.baeldung.com/wp-content/ql-cache/quicklatex.com-47124856215158c14ca0dd772bbc51c0_l3.svg)

### 4.2. 幂等操作

GET、HEAD 和 OPTION 显然是幂等的，因为它们只读取数据，但不创建、更新或删除任何资源。

PUT 是幂等的，因为它更新资源或创建新资源(如果不存在)。如果我们多次发送相同的更新，资源不应该改变。

### 4.3. 非幂等操作

POST 不必是幂等的，因为它创建一个新资源，如果再次调用，通常会创建另一个资源。但是，它也可以作为幂等操作来实现。

PATCH 操作会部分更新资源，并且不一定必须是幂等的。让我们看一个例子来更好地理解 PUT 和 PATCH 之间的区别：

假设我们要将商品添加到在线商店的购物车中。如果我们使用 PUT，我们需要发送完整的购物车数据，包括购物车中已经存在的所有商品。使用 PATCH，我们可以只发送要添加的项目，它将附加到购物车中已有的项目列表中。

如果我们再次发送 PATCH 请求，将再次添加相同的项目。当然，对于POST，我们也可以实现一个幂等的PATCH。

### 4.4. HTTP 响应

请务必注意，对幂等操作的多次调用不一定会产生相同的 HTTP 响应。

例如，如果资源已创建，PUT 将返回 201(已创建)，如果资源已更新，则将返回200(确定)或203(无内容)。

例如，当实际删除发生时，DELETE 可以返回200(确定)或204(无内容)。任何后续调用都将返回 404(未找到)。

## 5.总结

在本文中，我们了解了幂等性的含义、幂等性的好处是什么，以及它与 REST 的关系。

尽管幂等性的一般含义很容易理解，但在 API 设计过程中考虑副作用和 HTTP 响应等所有细微之处可能会非常棘手。