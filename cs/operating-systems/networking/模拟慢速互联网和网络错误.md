## 1. 概述

在部署之前测试我们的应用程序时，理想的做法是尽可能模拟实际预期条件。因此，我们必须设计一组输入数据，以正确运用所有可能的条件，包括极端情况。我们还将建立一个在架构上更接近生产环境的测试环境。在许多情况下，我们甚至会尝试加载压力。它应深入了解应用程序将如何在其预测负载下执行。此外，如果预计应用程序能够承受恶劣的环境条件，我们必须尝试这些条件. 例如，移动应用程序应该准备好从连接丢失、高数据包错误率、重复数据包或低带宽等连接问题中恢复。在本快速教程中，我们将讨论何时以及如何模拟网络条件以及我们可能使用的一些工具。

## 2. 为什么/何时模拟特定网络条件

在正常情况下，针对极端或不常见的网络条件测试应用程序可能有点矫枉过正。例如，期望应用程序后端与其位于同一子网中的数据库之间的通信出现高错误率是没有意义的。但是，如果它们相隔大洲，通过卫星链路连接，我们必须考虑更高的延迟和错误率。因此，为了检查特定网络条件模拟的需要，最好了解我们解决方案的每个组件将如何相互连接。对于每条通信路径，我们必须确定其性能要求、吞吐量、延迟、连接率、健壮性、并发性等。此外，我们必须注意通过可能无法满足性能要求的网络的通信流。好的候选者是不受我们管理的网络(例如 Internet、客户自己的 ISP)或依赖于非理想组件(例如卫星或无线电链路、高噪声物理层、拥塞网络)的网络。下图显示了流量整形代理的架构布局，它可以调节最终用户和表示层之间的网络流量。[![流量整形代理 3](https://www.baeldung.com/wp-content/uploads/sites/4/2022/05/traffic-shaping-proxy-3.svg)](https://www.baeldung.com/wp-content/uploads/sites/4/2022/05/traffic-shaping-proxy-3.svg)

## 3. 模拟慢速链接和错误

根据通信流程，我们要添加特定的模拟条件。有许多解决方案。如果我们只需要从最终用户的角度模拟 Web 应用程序的带宽限制，我们可以使用 Web 浏览器. 许多 Web 浏览器(如 Chrome、Edge 和 Firefox)都在其开发者模式设置中配置了限制流量的配置。对于数据包错误和延迟，我们必须使用其他解决方案。如果需要更多不同的条件测试，或者模拟解决方案中软件组件之间的问题，一些虚拟机环境允许创建具有有限带宽甚至丢包的虚拟网络。为了进一步控制，我们可以在软件组件之间添加充当路由器的虚拟主机，我们可以在其中添加其他效果，如延迟、数据包重复或无序。在这些路由器中，我们可以使用数据包过滤或流量整形代理。我们可能用来塑造软件组件之间流量的一些解决方案是：

### 3.1. 主机内防火墙或数据包过滤

许多数据包过滤解决方案都可以选择添加可以模拟特定网络问题的限制和数据包丢弃规则。在某些情况下，甚至可以使用操作系统的嵌入式数据包过滤器来完成，例如Linux中的[iptables或基于 BSD 的系统(FreeBSD、NetBSD、macOS X)中的](https://www.baeldung.com/linux/iptables-intro)[pf](https://www.openbsd.org/faq/pf/filter.html)，我们可能还需要使用第三方软件，例如在 Windows、 [dummynet](http://info.iet.unipi.it/~luigi/dummynet/)(各种操作系统)中[笨拙。](https://jagt.github.io/clumsy/index.html)

### 3.2. 网络代理应用程序

为了获得更大的灵活性和配置选项，我们可以使用网络代理应用程序，例如[NetEm(网络仿真)](https://wiki.linuxfoundation.org/networking/netem)或[Wondershaper](https://github.com/magnific0/wondershaper/)。这些程序可以重现更广泛的网络问题，例如数据包重复和重新排序。对于 Web 应用程序，我们还可以使用[Charles](https://www.charlesproxy.com/)或[Fiddler](https://www.fiddler2.com/)等 Web 调试代理。它们不仅允许模拟慢速连接，而且还具有保存和重放测试用例的工具，以便更轻松地创建压力测试。

### 3.3. Web 浏览器开发者模式

如果我们只需要评估最终用户体验，我们可以使用网络浏览器的本机开发人员模式控制台(例如[chrome devtools](https://developer.chrome.com/docs/devtools/))。除了允许我们模拟不同的设备和屏幕尺寸外，这些工具还具有网络节流功能。这样，我们就可以模拟带宽受限用户的用户体验。

### 3.4. 虚拟机软件

许多虚拟机软件，例如[VMware ESX](https://www.vmware.com/products/vsphere/distributed-switch.html)或[HyperV](https://docs.microsoft.com/en-us/windows-server/virtualization/hyper-v-virtual-switch/hyper-v-virtual-switch)，都与软件定义的虚拟交换机捆绑在一起。他们不仅可以限制虚拟端口的吞吐量，还可以在软件中重新创建复杂的网络配置。

## 4。总结

在本教程中，我们讨论了在特定网络问题和条件下应该探索应用程序行为的条件。即使我们觉得没有必要模拟特定的网络条件，我们也应该确保至少针对常见的网络问题(例如，连接丢失和超时)测试我们的应用程序。但在某些情况下，我们必须走得更远。在许多应用领域中，确保系统能够在不可靠的网络条件下工作是必不可少的。对于那些，一定要正确模拟和测试。