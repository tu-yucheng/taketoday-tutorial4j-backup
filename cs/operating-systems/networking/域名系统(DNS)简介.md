## 1. 概述

使用 IP 地址命名空间的全球网络设备之间的可靠通信是 Internet 的基石。然而，人类更自然地通过短名称而不是数字来记住东西。

域名系统 (DNS) 解决了这个问题，它帮助我们通过诸如google.com之类的名称而不是 IP 地址来访问 Internet 地址。通过本教程，我们将更好地理解 DNS 的核心概念和工作原理。

## 2. DNS 基础知识

让我们从 DNS 的基础知识开始。

### 2.1. 查找功能

为了能够访问 Internet 上的网站，Internet 浏览器需要一个查找系统来查找 Web 服务器的 IP 地址。

首先，浏览器会发送一个查找网站 IP 地址的请求。在第二步中，查找系统将以包含域 IP 地址的答案进行响应。最后，在第三步中，浏览器将能够使用 IP 地址连接到该网站：

![DNS v1](https://www.baeldung.com/wp-content/uploads/sites/4/2020/08/DNS_v1.png)

这样的查找系统必须能够存储与互联网上数十亿个活跃网站相对应的记录。但是，Internet 上的每个设备都不可能在本地存储如此庞大的映射集。

此外，此类查找对于 Internet 的高效运行至关重要。因此，为了让所有用户都能可靠地访问互联网，DNS被设计成一个分布式数据库系统。

### 2.2. 分布式系统

为了高度可靠，我们希望 DNS 高度可用、一致并且能够容忍网络分区中的故障。然而，正如[CAP 定理](https://www.baeldung.com/transactions-intro#2-cap-theorem)所说，我们不能同时拥有所有这些。

因此，当发生部分网络故障时，DNS 需要在可用性或一致性之间做出妥协。自然地，为了让 Internet 一直运行，它被设计成一个高度可用的系统：

![DNS CAP v1](https://www.baeldung.com/wp-content/uploads/sites/4/2020/08/dns-CAP_v1-1024x512-1.png)

需要注意的是，虽然 DNS 更喜欢可用性而不是一致性，但它是一个最终一致的系统。因此，随着时间的推移，不一致(如果有的话)将会消失。

在继续进一步探索的同时，让我们牢记这些设计决策。这将帮助我们更好地理解所有相关概念。

## 3.域名空间

域命名空间使域保持有序，以便于访问。此外，域命名空间的结构影响着DNS中各个组件的内部结构和具体功能。那么，现在让我们继续了解这个概念。

### ![域名空间 v1](https://www.baeldung.com/wp-content/uploads/sites/4/2020/08/Domain-Namespace_v1-1024x727-1.png)

### 3.1. 层次结构

要将 DNS 设计为可以存储数十亿域记录的分布式系统，我们需要找到一种合理的方法来跨多个节点分布整个域命名空间。因此，Internet 域名称空间不是无序集合，而是被视为分层树状结构，其中每个节点实际上都是一个域名。

在这里，想法是一组具有某些特征(例如从属关系或目的)的域将属于同一个家族：

 

当我们从上到下解析域名命名空间时，位于第一层的域名称为顶级域名 (TLD)。从广义上讲，有两种类型的 TLD：

-   通用顶级域 (gTLD)，例如com(商业)、edu(教育)和org(非营利)
-   国家代码顶级域 (ccTLD)，例如us、uk和in

接下来，直接在 TLD 下的是二级域，通常表示该域所属的组织。同样，二级域的正下方是有助于进一步组织属于同一组织的互联网地址的三级域。

因此，除了根域之外，所有其他域也称为父域的子域。但是，当上下文仅限于特定组织时，三级域简称为子域。

### 3.2. 完全限定域名 (FQDN)

从域命名空间中的任何节点，如果我们向上遍历到根节点，那么我们将得到它的绝对路径：

![DNS fqdn v1](https://www.baeldung.com/wp-content/uploads/sites/4/2020/08/dns-fqdn_v1-1024x512-1.png)

与相对于父域的子域的概念不同，绝对路径是明确的。因此，当我们写下这条用点分隔的路径时，我们就得到了DNS 内部可以使用的完全限定域名 (FQDN)。

当涉及到有效域的命名约定时，有一些准则：

-   我们只能使用数字 ( 0-9 )、字母 ( az, AZ)或连字符 ( – )
-   我们不能以连字符开头的域名
-   FQDN 不能超过 255 个字符，每个单独的部分不超过 63 个字符

有了这些限制，解析 FQDN 和提取单个字符串(例如 TLD 或主要域)变得更加容易。

### 3.3. 区域

查看域名称空间树，我们可以将任何非叶节点视为代表在其 FQDN 中具有相同右侧的域地址系列。最重要的是，区域是由同一域名服务器管理的域命名空间中的一组域地址。

假设与google.com、docs.google.com和sheets.google.com相关的信息由单个 DNS 服务器维护，而dns.google.com由不同的 DNS 服务器管理：

![DNS 区域 v1](https://www.baeldung.com/wp-content/uploads/sites/4/2020/08/dns-zones_v1-e1597031602429-1024x879-1.png)

 

所以，我们可以在这里看到两个 DNS 区域，即ZONE-1和 ZONE-2。其中，ZONE-2的范围是域google.com 的子域 ( dns.google.com )，此类区域通常称为从属区域。

## 4. DNS 客户端-服务器架构

在较高的抽象层次上，DNS 建立在[客户端-服务器架构模型](https://en.wikipedia.org/wiki/Client–server_model)之上：

![DNS 拱形 v1](https://www.baeldung.com/wp-content/uploads/sites/4/2020/08/dns-arch_v1-1024x512-1.png)

在客户端-服务器模型中，域名解析请求由 DNS 客户端发起，也就是俗称的 DNS 解析器。作为回报，DNS 的分布式网络响应客户端。

然而，由于 DNS 本质上是一个层次化的分布式系统，具体的流程并不像这里看起来那么简单。

有一点需要理解，因为数据分布在多个服务器上，第一个获得查询的服务器可能无法自己回答查询。因此，它可能会从另一个 DNS 服务器寻求答案，而在这样做的同时，它扮演了 DNS 解析器的角色。

## 5. 名称服务器 (NS)

名称服务器是 DNS 的核心功能组件，因为它们存储将域名转换为 IP 地址所需的相关信息，反之亦然。此外，根据它们存储的信息类型，它们可以分为不同的类型。让我们更多地了解它们。

### 5.1. 权威名称服务器

从管理的角度来看，权威名称服务器由管理员配置以保存区域的权威数据源。因此，要回答对该区域中域的 DNS 查询，所有其他名称服务器都需要在某个时间点直接或间接咨询该名称服务器。

与域名空间一样，权威名称服务器遵循层级顺序，根区域的权威名称服务器位于树的顶部。一般来说，术语区域经常被删除，因此根区域的 DNS 服务器通常称为[根服务器](https://www.iana.org/domains/root/servers)，TLD 区域的 DNS 服务器是 TLD 服务器，等等。

### 5.2. 缓存名称服务器

尽管域信息是可变的，但是，在大多数情况下，很多此类信息(例如 IP 地址)在相当长的一段时间内不会发生变化。因此，缓存是一种方便的选择，可以帮助减少进入权威名称服务器的 DNS 查询数量。

一方面，缓存提高了 DNS 的性能，大多数面向互联网的应用程序都从中受益。同时，另一方面，它也引入了系统不一致的可能性，其中权威名称服务器更改了一些信息。但是，缓存名称服务器仍在使用缓存的结果进行应答。

在某种程度上，不一致的问题是通过基于权威名称服务器为该记录配置的[TTL (生存时间)值使缓存结果过期的机制解决的。](https://en.wikipedia.org/wiki/Time_to_live#DNS_records)因此，DNS 不是一个强一致性系统，但它仍然提供最终一致性。

## 6. DNS 解析

到目前为止，一切都很好！现在，我们对 DNS 系统的核心组件有了一定的了解。因此，作为下一步，让我们看看这些组件如何协作来回答 DNS 查询。

### 6.1. 递归和非递归查询

为了回答翻译查询，DNS 利用域名称空间和权威名称服务器的分层组织。

在进行 DNS 查询时，客户端可以灵活地选择递归或非递归查询。对于前者，它期望服务器给它一个明确的查询答案。然而，对于后者，它需要一个明确的答案或一个可能包含答案的推荐名称服务器：

![DNS 查询 v1](https://www.baeldung.com/wp-content/uploads/sites/4/2020/08/dns-query_v1-1024x512-1.png)

为了满足请求，DNS 解析器从右到左解析 FQDN 并隔离其各个部分。然后，它会从根服务器开始调用几个非递归查询。作为响应，它要么有一个答案，要么有一个它接下来应该查询的推荐名称服务器。

最后，最后的响应返回给客户端。在这整个事件链中，我们必须注意，解析器通常具有根服务器的硬编码地址，这有助于它们到达服务器树的根节点。之后，引用服务于树遍历的目的。

### 6.2. 转发器和递归器

虽然 DNS 解析器可以决定他们是要启动递归查询还是非递归查询，但 DNS 服务器也有类似的灵活性：

-   转发服务器可以将 DNS 查询转发到另一台 DNS 服务器
-   递归服务器将自行解析 DNS 查询

我们必须注意，任何 DNS 查询的解析都将以一个或多个 DNS 转发器开始，并以 DNS Recursor 结束。

自然地，服务递归查询涉及服务器比服务非递归查询更多的工作。所以，如果我们必须设置一个递归服务器，那么我们必须考虑到这一点。然而，对于大多数一般用途，我们可以使用互联网巨头(如[Google](https://developers.google.com/speed/public-dns/)或[Cloudflare](https://1.1.1.1/dns/) )提供的公共 DNS 解析器。

## 7. DNS 资源记录

到目前为止，我们的讨论仅限于将域名转换为 IP 地址。然而，DNS 能够为 Internet 域存储其他几种资源记录：

-   记录映射到 IPv4 地址
-   AAAA记录映射到 IPv6 地址
-   CNAME记录作为别名并映射到规范域名
-   MX 记录映射到可以代表域发送或接收电子邮件的邮件服务器
-   NS 记录映射到区域的权威名称服务器

我们必须注意，这些只是最常用的记录。就此而言，如果我们以基于微服务的分布式系统为例，那么[SRV](https://en.wikipedia.org/wiki/SRV_record)记录在服务发现中起着至关重要的作用，因为它们可以将 IP 地址和端口映射到服务名称。

## 八、总结

在本教程中，我们了解了各种主题，例如域名称空间、名称服务器和 DNS 背后的体系结构。我们深入到每个主题，以清楚地了解 DNS 查询解析的过程。