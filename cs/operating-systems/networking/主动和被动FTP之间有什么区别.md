## 1. 概述

文件传输协议 - FTP - 几乎与 Internet 本身一样古老。它的首次发布甚至早于当前的 TCP/IP，早在 70 年代初期。[当前的标准是RFC 959](https://datatracker.ietf.org/doc/html/rfc959)，于 1985 年发布。FTP是[OSI模型](https://www.baeldung.com/cs/osi-model)中的应用层协议。2021 年，大多数网络浏览器开始[终止](https://en.wikipedia.org/wiki/File_Transfer_Protocol#Web_browser)对该协议的原生支持。然而，在过去甚至今天，很容易找到嵌入在许多网站中的 FTP URL。在本教程中，我们将讨论 FTP 的操作方式，详细说明主动和被动操作模式之间的区别。

## 2、FTP

FTP 旨在允许轻松地向多供应商分布式环境传输文件和进行远程文件管理。那时，仍然存在大量不兼容的专有硬件和软件架构。由于其简单性，它已成为全球常规数据中心运营中非辅助批处理文件传输例程的标准之一。因此，FTP 可以选择使用不同的文件编码(二进制、[ASCII](https://en.wikipedia.org/wiki/ASCII)和[EBCDIC](https://en.wikipedia.org/wiki/EBCDIC)文件)、数据传输模式(流、块和压缩——非常有限)和操作模式(主动和被动)。它甚至允许客户端命令在两个不同的服务器之间传输，或在服务器上执行特定的例程。选项仅在成熟的 FTP 客户端中可用。标准FTP[URL](https://datatracker.ietf.org/doc/html/rfc3986)具有以下语法：

```http
ftp://[user[:password]@]<host><.domain>/<path>/<file>
```

FTP 使用多个连接运行：

-   Control Connection：最先打开，默认使用TCP 21端口，客户端在这里向服务器发送命令
-   数据连接：每个数据传输(包括目录列表)都会打开自己的数据连接，该数据连接会在流完成后关闭。

因此，主动模式和被动模式之间的主要区别在于哪一侧将打开，哪一侧将监听数据连接。在主动模式下，服务器主动打开数据连接(默认情况下，它使用 TCP 端口 20 作为其来源)回调客户端。相反，在被动模式下，所有连接都从客户端打开到服务器。

## 3.主动与被动模式连接流程

被动模式后来被添加到规范中——几乎在同一时间，互联网主机管理员了解了使用网络防火墙(查看我们的[防火墙介绍教程](https://www.baeldung.com/cs/firewalls-intro))和适当的网络分段的必要性。那时，配置防火墙以允许主动模式操作回调连接非常棘手。它需要使用端口触发进行完整的数据包检查，这是一种防火墙规则，在检测到另一个端口上的有效流量后激活一个端口，以允许服务器实际到达客户端的回调监听端口。被动模式简化了这一点，不需要客户端的防火墙打开由控制连接内协商的内容触发的入站端口。所以，使用被动模式，只有服务器端的防火墙需要全面检查流量以打开数据传输所需的端口。顺便说一句，使用 HTTP 或 HTTPS 传输文件的一个优点就是：不需要多个数据连接或防火墙深度检查技巧。下图显示了两种 FTP 操作模式。大多数客户端(网络浏览器是明显的例外)的默认设置是默认使用活动模式：[![f1](https://www.baeldung.com/wp-content/uploads/sites/4/2021/12/f1.svg)](https://www.baeldung.com/wp-content/uploads/sites/4/2021/12/f1.svg)   

## 4. 我们应该使用什么(或如何使用)？

好吧，如果可以的话，我们应该避免使用 FTP。为什么？首先，FTP 流量是明文的，这意味着用户和密码以及数据传输本身都是在没有任何隐私问题的情况下发送的。数据流之间的任何人不仅可以捕获文件，还可以捕获启动新数据传输所需的凭证。为了确保数据和凭证隐私，我们应该尝试启用加密的对应物，如[SFTP](https://www.baeldung.com/cs/popular-network-protocols)、 SCP 或[HTTPS](https://www.baeldung.com/cs/https-urls-encrypted)。或者，至少，通过 VPN 或[SSH 隧道](https://www.baeldung.com/linux/ssh-tunneling-and-proxying)使用它。对于批量传输，另一个合理的选择是[RSYNC](https://www.baeldung.com/linux/remote-file-synchronization) over SSH、VPN 或[SSHFS](https://www.baeldung.com/linux/mounting-remote-directory-sshfs). 如果我们有太多小文件，FTP 为每个传输设计的一个数据连接会强加一些 RSYNC 会避免的额外开销。除此之外，在连接丢失的情况下，端点通常会保留部分传输的文件。因此，我们需要检查文件传输是否已成功完成。更常用的方法是：

-   发送带有轨迹、标题或分离的元数据文件的文件
-   检查生成的文件大小
-   检查文件的哈希签名
-   将文件传输到临时文件夹或文件名，并仅重命名已知成功的传输

添加和检查文件哈希签名的一种简单方法是将它们压缩为 ZIP 文件，或者使用我们首选的压缩方案(当然，只要它具有文件检查功能)。但是，无论如何，如果我们必须使用 FTP，被动模式通常更容易通过防火墙，应该默认使用。尽管如此，在任何情况下，防火墙都应该知道它正在寻找 FTP 连接，以便应用正确的过滤模式。如果我们不使用标准 TCP 端口进行控制和数据连接，则尤其如此。

## 5.总结

在本教程中，我们展示了 FTP 的主动和被动操作模式。虽然 FTP 正在慢慢过渡到遗留 Internet 协议列表，但它仍在广泛使用。了解其运行模式有助于在大多数情况下正确选择最佳数据传输架构。当我们拥有旧计算机和操作系统时，FTP 的用处更加明显。它在异构环境中表现出色，或者当我们想要在服务器之间自动移动数据时，因为编写默认命令行客户端脚本很容易。