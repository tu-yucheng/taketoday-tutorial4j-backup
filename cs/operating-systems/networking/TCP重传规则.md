## 1. 概述

[传输控制协议 (TCP)](https://www.baeldung.com/a-guide-to-java-sockets)是一种通信标准，它使应用程序和计算设备能够通过网络交换消息。它旨在通过 Internet 发送数据包，并确保通过网络成功传递数据和消息。

在本教程中，我们将研究 TCP 重传：它的定义、原因及其工作原理。

## 2. TCP重传

TCP 提供可靠的字节流传输服务，建立在 Internet 协议提供的尽力而为的数据报传送服务之上。TCP 通过将数据分成 TCP 段并在 IP 数据包中传输这些段来实现这一点。正如我们所知，与[用户数据报协议 (UDP)](https://www.baeldung.com/udp-in-java)不同，TCP 使用三次握手过程来建立[TCP 连接](https://www.baeldung.com/cs/tcp-active-vs-passive)，如下图所示：

![TCP的3次握手](https://www.baeldung.com/wp-content/uploads/sites/4/2022/12/3-Way-Handshake-2.png)

建立连接后，发送方开始向接收方传输 TCP 数据段。但是，发送方发送的一个或某些 TCP 段可能在到达接收方之前在途中丢失。这会导致接收方向发送方发送具有相同 ACK 编号的确认 (ACK)。结果，发送方向接收方重传相同的段。这称为 TCP 重传。数据包的重传是[TCP和UDP的区别](https://www.baeldung.com/cs/udp-vs-tcp)之一。

## 三、丢包原因

并非所有发送到链路的数据包都必须被链路另一端的接收方成功接收。有[许多可能导致数据包丢失的原因](https://www.baeldung.com/cs/udp-packet-loss)。这些可能发生在帧通过链接时，包括：

-   信道噪声造成的丢失通常以随机帧丢失为特征。信道噪声也可能由其他降低通信量的信道条件引起
-   由于信道干扰导致的帧丢失。这种干扰可以是随机的、结构化的，在某些情况下甚至是周期性的
-   链路中断，在此期间链路丢失所有或几乎所有帧，直到链路恢复。这是某些类型链路的共同特征，例如移动蜂窝无线电。

其他形式的数据包丢失与信道条件无关，但包括：

-   在使用竞争感知 MAC 协议的共享信道中传输的帧丢失(例如，由于冲突)。在这里，许多协议要求延迟重传以促进共享信道的稳定性(即防止过度的信道争用)
-   数据包由于拥塞而丢弃。队列最终会溢出，因为要发送的新数据包的到达率继续超过链路上的传出数据包传输率
-   由于实施错误造成的损失，包括硬件故障和软件错误。这被认为是终端主机中检测到的数据包损坏的常见原因

丢失率和丢失模式是物理层和链路层设计的函数。这些在不同的链路配置中差异很大。当在不同类型的信道上运行时，特定实现的性能也可能在相同的链路配置上有很大差异。

## 4. 什么时候发生TCP重传？

发送方发现 TCP 段丢失时

-   要么超时定时器到期
-   或者它收到三个重复的确认

### 4.1. 超时定时器到期后重传

每次发送方向接收方传输一个 TCP 数据段时，它都会启动一个超时计时器。

现在，可能有以下两种情况：

-   在计时器关闭之前，发送方会收到已发送段的 ACK。在这种情况下，发送者停止定时器
-   发送方没有收到对发送段的任何 ACK，计时器关闭。在这种情况下，发送方认为发送的段丢失了。发送方向接收方重传相同的段并重置定时器

下图说明了超时定时器超时后 TCP 重传的示例：

![超时定时器到期后重传](https://www.baeldung.com/wp-content/uploads/sites/4/2022/12/Retransmission-after-Time-Out-Timer-Expiry.png)

### 4.2. 收到 3 个重复 ACK 后重传

当发送方收到它发送的一个 TCP 报文段的三个重复 ACK 时，它会认为相应的报文段丢失了。发送方然后重传相同的段而不等待其超时计时器到期。这称为早期重传或快速重传。

考虑发送方向接收方发送 5 个 TCP 段，如下图所示：

![收到3个重复ACK后重传](https://www.baeldung.com/wp-content/uploads/sites/4/2022/12/Retransmission-after-receiving-3-duplicate-acknowledgements.png)

第二个 TCP 段在到达接收方之前就丢失了。发生的步骤顺序是：

-   在接收到段 1 时，接收方发送 ACK 请求下一个段 2(原始 ACK)
-   在接收到段 3 时，接收方发送 ACK 请求下一个段 2(第一个重复 ACK)
-   在接收到第 4 段时，接收方发送 ACK 请求接下来的第 2 段(第 2 个重复 ACK)
-   在接收到段 5 时，接收方发送 ACK 请求下一个段 2(第 3 个重复 ACK)。

现在，发送方总共收到 3 个对 Segment 2 的重复 ACK。因此，发送方假定段 2 丢失。无需等待定时器关闭就可以为段 2 建立重传。

需要注意的是，接收方在收到重传的Segment 2后，并不发送请求Segment 3、4、5的ACK，而是直接从发送方发送请求Segment 6的ACK。这是因为已经收到了前面的段，并且已经发送了它们的 ACK(尽管在请求段 2 时浪费了)。

## 5.总结

在本文中，我们介绍了 TCP 重传的概念和原理。

我们已经了解了导致网络链路丢包的原因。我们还了解了建立 TCP 重传的两个主要规则，即超时计时器到期和发送方收到三个重复的 ACK。通过采用重传机制，TCP 协议保证数据包从发送方传送到接收方，从而提供可靠的通信并提高[网络性能](https://www.baeldung.com/cs/bandwidth-packet-loss-latency-jitter)。