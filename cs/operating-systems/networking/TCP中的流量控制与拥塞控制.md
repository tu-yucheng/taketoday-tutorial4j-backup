## 1. 概述

在本教程中，我们将讨论 TCP 中两种流行的流量控制方法：流量控制和拥塞控制。首先，我们将详细介绍 TCP 中的流量和拥塞控制是如何工作的。

最后，我们将讨论它们之间的核心区别。

## 2. TCP中的流量控制

流量控制处理在没有收到任何确认的情况下发送到接收方的数据量。它确保接收器不会被数据淹没。这是发送方和接收方之间的一种速度同步过程。[OSI 模型](https://www.baeldung.com/cs/osi-model)中的[数据链路层](https://www.baeldung.com/cs/osi-model)负责促进流量控制。

让我们通过一个实际的例子来理解流量控制。杰克正在参加培训课程。让我们假设他在掌握老师教的概念方面很慢。另一方面，老师在没有得到学生的任何认可的情况下讲得很快。

一段时间后，他老师说的每一句话都在杰克的脑海中浮现。因此，他什么都不懂。在这里，教师应该了解学生一次可以处理多少个概念。

过了一段时间，Jack 被数据淹没了，请求老师放慢速度。老师决定先讲授一些概念，然后等待学生的认可，然后再进行以下概念。

与示例类似，流量控制机制告诉发送方可以将数据发送到接收方设备的最大速度。发送方根据接收方的能力调整速度，以减少接收方的[帧丢失](https://www.baeldung.com/cs/networking-packet-fragment-frame-datagram-segment)。

[TCP](https://www.baeldung.com/cs/udp-vs-tcp)中的流量控制可确保在接收缓冲区已完全填满的情况下不会向接收方发送更多数据。接收器缓冲区指示接收器的容量。当接收缓冲区已满时，接收方将无法处理数据：

![流量控制](https://www.baeldung.com/wp-content/uploads/sites/4/2021/10/flow_control.drawio-1024x417.png)

## 3. 滑动窗口协议简介

TCP 中流行的流量控制机制之一是滑动窗口协议。这是一个可变大小的面向字节的过程。

在这个方法中，当我们在发送方和接收方之间建立连接时，接收方将接收窗口发送给发送方。接收器窗口是接收器缓冲区中当前可用的大小。

现在，TCP 从可用的接收窗口计算可以在没有确认的情况下进一步发送多少数据。但是，如果接收方窗口大小为零，TCP 会停止数据传输，直到它变为非零值。

接收窗口大小是[TCP 段](https://www.baeldung.com/cs/udp-vs-tcp)帧的一部分。window size 的长度是 16 位，这意味着窗口的最大尺寸是 65,535 字节。

接收者决定窗口的大小。接收方在每个确认消息中发送当前可用的接收窗口大小。

### 3.1. 滑动窗口协议中的进程

滑动窗口协议中有三个过程：开窗、闭窗、缩窗。

opening window process 允许缓冲区中有更多的数据可以发送：

![关窗](https://www.baeldung.com/wp-content/uploads/sites/4/2021/10/closing_the_window.drawio-1024x323.png)

关闭窗口过程表明一些发送的数据字节已经被确认，发送者不需要再担心它们了：

![打开窗户](https://www.baeldung.com/wp-content/uploads/sites/4/2021/10/opening_the_window.drawio-1024x334.png)

缩小窗口过程表示窗口大小的减小。这意味着一些字节有资格传输。尽管由于窗口大小减小，发送方不会传输这些字节。接收方可以打开或关闭窗口，但不建议缩小窗口。

### 3.2. 例子

假设有两个设备：Device-A 和 Device-B。Device-A 想要向 Device-B 发送 300000 字节的数据。首先，TCP 将数据分成每个大小为 1500 字节的小帧。因此，总共有 200 个数据包。一开始，我们假设 Device-B 将可用的接收窗口通知给 Device-A，即 60000 字节。这意味着 Device-A 可以在没有收到 Device-B 的确认的情况下向 Device-B 发送 60000 个字节。

现在 Device-A 最多可以发送 40 个数据包 (150040 = 60000) 而无需等待确认。因此，Device-A 必须等待五个确认消息才能完成整个传输。计算所需确认消息的数量，并考虑设备 B 的接收缓冲区容量：

![TCP 示例](https://www.baeldung.com/wp-content/uploads/sites/4/2021/10/tcp_example.drawio-1024x624.png)

在这里，TCP 负责安排数据包并使窗口大小为 60000 字节。此外，TCP 有助于将落在窗口范围内的数据包从设备 A 传输到设备 B。发送数据包后，它等待确认。如果已收到确认，它将窗口滑动到下一个 60000 字节并发送数据包。

我们知道 TCP 在接收方发送零大小窗口时停止传输。但是，有可能接收方已发送确认但被发送方错过。

在那种情况下，接收方等待下一个数据包。但另一方面，发送方正在等待非零窗口大小。因此，这种情况会导致[死锁](https://www.baeldung.com/cs/os-deadlock)。为处理这种情况，TCP 在接收到零窗口大小时启动持久计时器。它还定期向接收方发送数据包。

## 4.拥塞控制

拥塞控制是一种在网络的每个节点上限制数据包流量的机制。因此，它可以防止任何节点因过多的数据包而过载。当数据包流向任何节点的速率超过其处理能力时，就会发生拥塞。

当发生拥塞时，它会减慢[网络响应时间](https://en.wikipedia.org/wiki/Latency_(engineering))。结果，网络的性能下降。发生拥塞是因为[路由器和交换机](https://www.baeldung.com/cs/routers-vs-switches-vs-access-points)有一个队列缓冲区，用于保存数据包以供处理。保持过程完成后，它们将数据包传递给下一个节点，从而导致网络拥塞。

TCP拥塞控制分为三个阶段：慢启动、拥塞避免和拥塞检测：

![拥塞控制阶段](https://www.baeldung.com/wp-content/uploads/sites/4/2021/10/congestion_control_phase.drawio-1024x233.png)

### 4.1. 慢启动

在拥塞控制的第一阶段，发送方发送数据包并逐渐增加数据包的数量，直到达到阈值。我们从流控制讨论中知道，窗口大小由接收者决定。

同理，在拥塞控制机制中也有一个窗口大小。它逐渐增加。在流量控制中，窗口大小(RWND)与 TCP 标头一起发送。尽管在拥塞控制中，发送节点或终端设备存储它。

发送方开始发送窗口大小 (CWND) 为 1 MSS(最大段大小)的数据包。MSS 表示发送方可以在单个报文段中发送的最大数据量。最初，发送方只发送一个段并等待段 1 的确认。之后，发送方每次将窗口大小(CWND)增加 1 MSS。

慢启动过程不能无限期地持续下去。因此，我们 通常使用一个称为慢启动阈值(SSTHRESH)的阈值来终止慢启动过程。当窗口大小(CWND)达到慢启动阈值时，慢启动过程停止，下一阶段的拥塞控制开始。在大多数实现中，慢启动阈值的值为 65,535 字节。

### 4.2. 拥塞避免

拥塞控制的下一阶段是拥塞避免。在慢启动阶段，窗口大小 (CWND) 呈指数增长。现在，如果我们继续以指数方式增加窗口大小，总有一天会导致网络拥塞。

为了避免这种情况，我们使用拥塞避免算法。拥塞避免算法定义了如何计算窗口大小(CWND)：

 ![[窗口大小 (CWND) = 窗口大小 (CWND) + 最大段大小 (MSS) / 窗口大小 (CWND)]](https://www.baeldung.com/wp-content/ql-cache/quicklatex.com-486ff061d8915599431ec68388387dd0_l3.svg)

每次确认后，TCP 确保窗口大小 (CWND) 的线性增量，比慢启动阶段慢。

### 4.3. 拥塞检测

第三阶段是拥塞检测。现在在拥塞避免阶段，我们降低了窗口大小(CWND)的增量速率，以降低网络拥塞的可能性。如果网络中仍然存在拥塞，我们应用拥塞检测机制。

TCP 检测到拥塞有两种情况。首先，当在估计的时间内没有收到对发送方发送的数据包的确认时。第二种情况发生在接收方收到三个重复的确认时。

在超时的情况下，我们开始一个新的慢启动阶段。为了处理第二种情况，我们开始一个新的拥塞避免阶段。

## 5. 一个实际例子

总结一下TCP中的流量和拥塞控制，我们举一个实际的例子。

杰克早上醒来，准备去办公室。途中，他要穿过多个路口，每个路口都有交通信号灯。在办公室里，有一部电梯可以把他带到他办公室的地板上。

在这个例子中，所有的交通信号都试图控制从一个路口到另一个路口的拥堵。它的工作原理与维护网络中从一个节点到另一个节点的段流相同。最后，当杰克到达办公楼时，流量控制开始了。保安人员根据电梯容量控制电梯人员的出入。就好比receiver buffer的概念流入控制：

![拥塞控制示例](https://www.baeldung.com/wp-content/uploads/sites/4/2021/10/congestion_control_example.drawio-1024x598.png)

## 6. 差异

下面说说TCP中流量控制和拥塞控制的核心区别：

![由 QuickLaTeX.com 呈现](https://www.baeldung.com/wp-content/ql-cache/quicklatex.com-ba111bd55efe3b2296585bac162caacc_l3.svg)

## 七、总结

在本教程中，我们讨论了 TCP 中的流量和拥塞控制机制。我们通过示例介绍了这些机制中涉及的概念和协议。

最后，我们探讨了它们之间的核心区别。