## 1. 概述

在本教程中，我们将讨论一些模棱两可的概念，即高速缓存未命中、TLB(转换后备缓冲区)未命中和页面错误。要理解这些概念，我们必须首先弄清楚它们是如何像交响乐一样协同工作的。然后我们将深入了解每个组件的更多细节，以及为什么我们首先需要它们。

## 2.定义

在尝试理解它们如何一起工作之前，让我们先看看定义。

### 2.1. 缓存

缓存就像 RAM，但它更接近 CPU。CPU 无需一路通过 RAM 来访问必要的数据，而是可以更快地从缓存中获取数据。但是，如果缓存中不存在数据，则会出现缓存未命中。

### 2.2. TLB

我们可以把TLB看成是[内存缓存](https://en.wikipedia.org/wiki/Translation_lookaside_buffer)。它减少了访问内存位置所花费的时间。我们也称它为地址翻译缓存，因为它存储虚拟内存到物理内存的最新翻译。

### 2.3. 页表

操作系统中的[虚拟内存](https://www.baeldung.com/cs/physical-vs-virtual-memory#virtual-memory)系统将其用作数据结构。它存储了虚拟内存和物理内存之间的映射关系。[内存管理单元](https://en.wikipedia.org/wiki/Memory_management_unit)处理这个特定的转换。

页表的每一项都有一个标志，指示相关页是否为物理内存。页表条目包括存储页面的物理内存地址(如果它在物理内存中)。但是，如果硬件引用一个页面，而该页面的页表条目表明它不在物理内存中，则会发生页面错误。这将调用操作系统的分页管理器组件。

## 3.内存层次结构

如果没有内存层次结构，程序员几乎不可能拥有无限量的快速内存。根据[局部性原则](https://en.wikipedia.org/wiki/Locality_of_reference)，大多数程序不会统一访问所有代码或数据。由于这个原则，结合更小的硬件是更快的观点，内存层次结构在速度、成本和大小上有所不同。我们可以在下图中看到不同级别的内存层次结构：

![MH2](https://www.baeldung.com/wp-content/uploads/sites/4/2021/12/mh2.png)

### 3.1. 为什么我们需要高速缓存、TLB 和虚拟寻址？

目标是提供一种成本更低、存取速度更快、面积更大的存储系统。这导致不同级别的不同解决方案。缓存提高了 CPU 的性能；CPU 可以直接访问缓存，而不是一直访问内存。此外，虚拟内存使物理内存对程序员来说是无限的。通过使用虚拟寻址，物理内存扮演着磁盘缓存的角色。

当我们需要缓存进行虚拟寻址时，TLB 就登场了，充当虚拟内存的缓存。它是一种用于最近使用的地址转换的特殊缓存。操作系统将 TLB 未命中作为异常处理。它有一个简单的替换策略，因为 TLB 未命中经常发生。

当我们从整体上看时，我们可以看到缓存机制在内存层次结构中起着至关重要的作用。它不仅会影响硬件级别的性能，该机制本身也会导致解决其他抽象级别的其他问题。

## 4.缓存未命中、TLB未命中和页面错误

在详细介绍缓存、[虚拟内存、物理内存](https://www.baeldung.com/cs/physical-vs-virtual-memory)、TLB 以及它们如何协同工作之前，让我们先看看下图中的整体情况。我们简化了下图，以免考虑一级和二级现金的区别，因为它已经混淆了所有位的位置：

![内存概览](https://www.baeldung.com/wp-content/uploads/sites/4/2021/12/os-kernel-Page-2.png)

首先，我们可以看到虚拟地址在逻辑上分为页号和页偏移量。页码被发送到TLB；如果 TLB 匹配成功，则将物理页码发送到缓存标记以控制它是否匹配。如果匹配，则缓存命中。否则，这是缓存未命中。在这种情况下，我们使用物理地址从内存中获取块，并且缓存将被更新。

如果我们在 TLB 中找不到页面，就会发生 TLB 未命中。这种情况，我们去页表中寻找对应的页。如果我们在页表中找不到对应的页，就会发生缺页错误。在这种情况下，我们通过操作系统从磁盘读取页面。

当我们将页面传输到内存中时，内存可能已满。在这种情况下，我们将找到一个受害页面并用新页面 P 覆盖受害页面。然后我们将更新页表和 TLB。

这就是整个机制在幕后的工作方式。我们简化了一些部分以分享所有这些概念背后的主要思想。当我们深入细节时，我们会看到有不同的缓存级别，以及不同类型的 TLB 进入阶段以解决内存层次结构中的问题。

## 5. 缓存和虚拟内存的区别

尽管许多术语不同，但缓存在某些方面类似于虚拟内存。页面或段就像一个块，因此页面错误或地址错误对应于未命中。正如我们之前在本文中提到的，CPU 生成虚拟地址。

硬件和软件处理这些地址并将它们转换为访问主(物理)内存的物理地址。我们称此过程为内存映射或地址转换。

缓存和虚拟内存之间还有其他区别：

-   硬件负责替换缓存未命中。但是，操作系统控制着虚拟内存的替换。
-   虚拟内存的大小取决于处理器地址的大小，而高速缓存的大小与处理器地址的大小无关。
-   虚拟内存不仅是主存的底层后备存储，也是[文件系统](https://www.baeldung.com/cs/files-file-systems)的存储。

## 六，总结

在本文中，我们分享了计算系统中内存层次结构设计的重要概念，首先，我们给出了缓存未命中、TLB 未命中和页面错误的整体视图。然后我们简单介绍了这些概念。最后，我们指出了缓存和虚拟内存的区别。