## 1. 概述

在本教程中，我们将讨论服务器应使用的合适的线程数阈值。我们如何确定这个阈值是多少？在尝试找到一种合理的技术来估计理想的截止值或回答“多少线程太多？”这个问题之前，我们将回顾重要的概念。

## 2.进程和线程

计算中的[进程是在一个或多个](https://www.baeldung.com/cs/process-scheduling)[线程](https://www.baeldung.com/cs/process-vs-thread)上运行的计算机程序的实例。一个进程可以由多个并发运行的执行线程组成，具体取决于操作系统。

有许多不同的进程模型，其中一些是轻量级的，但几乎所有进程都起源于操作系统进程，它由程序代码、分配的系统资源、物理和逻辑访问权限以及启动、控制的数据结构组成，并协调执行活动。

进程是指令从磁盘加载到内存后执行指令的行为，与计算机程序相反，计算机程序是通常保存在磁盘文件中的指令的被动集合。同一个程序可能与多个进程相关联；例如，打开同一软件的多个实例经常会导致执行多个进程：

![进程VS线程](https://www.baeldung.com/wp-content/uploads/sites/4/2022/08/ProcessVsThread.png)

线程与传统的多任务操作系统进程有多种不同之处。线程通常是进程的子组，而进程通常是自治的。与线程相比，进程携带了更多的状态信息。一个进程的多个线程可以共享系统内存、其他资源和进程的状态。

进程有独立的地址空间，而线程共享它们的地址空间。只有系统提供的进程间通信通道才允许进程通信。通常，单个进程内的上下文切换比进程之间的上下文切换发生得更快。

### 2.1. 线程与进程的优缺点

与使用多个进程相比，程序在使用线程时可以使用更少的资源。对于[进程间通信](https://www.baeldung.com/cs/inter-process-communication)(IPC)，进程需要共享内存或消息传输机制，而线程可以使用它们已经共享的数据、代码和文件进行通信。

线程执行的未经授权的操作可能会导致进程崩溃，因为线程共享相同的地址空间。因此，一个坏线程可以阻止应用程序中的所有其他线程处理它们的数据。

在同一进程中运行的一组线程称为线程组。它们可以访问相同的全局变量、文件描述符集合和堆内存，因为正如我们刚才提到的，它们共享相同的内存。

这些线程都同时运行。如果机器有多个处理器，则使用时间片或真正的并行处理。同时执行大量任务是使用线程组而不是进程组的好处之一。这使得在事件发生时对其进行管理成为可能。

上下文切换是使用线程组而不是进程组的好处。跨线程交换上下文比在进程之间交换上下文要快得多。

### 2.2. 创建过多线程的案例

如果我们生成数千个线程，我们的工作将需要更长的时间才能完成，因为我们将不得不花时间在它们的上下文之间切换。使用线程池来完成我们的任务而不是手动创建新线程，以便操作系统可以平衡理想的线程数。

普遍的共识是拥有更多的物理内核比拥有更多的线程更可取。相比之下，一个 8 核 8 线程的 CPU 会比 2 核 8 线程的 CPU 表现更好。然而，我们的 CPU 可以管理的线程越多，它在多任务处理时的表现就越好。此外，对于一些特别密集的应用程序，它会同时使用多个核心。

核心数是指 CPU 芯片上的实际核心数，而线程数是指并发运行的应用程序线程总数。这与核心数相同，不需要额外的硬件。但是，某些 CPU 的线程数多于内核数。

### 2.3. 太多线程会影响性能

过多的线程可能会产生两个负面影响。首先，当固定数量的工作分配给太多线程时，每个线程收到的工作太少，以至于与启动和停止线程相关的开销超过了生产性工作。其次，由于线程竞争有限的硬件资源，运行过多的线程会导致开销。

区分硬件线程和软件线程至关重要。程序创建线程，称为“软件线程”。硬件上的线程是实际的物理资源。芯片的每个内核可能有一个或多个硬件线程。

将可运行线程数限制为硬件线程数是一种明智的解决方案。如果缓存争用是一个问题，我们可能还希望将其限制为外层缓存的数量。避免将我们的软件硬编码到特定数量的线程，因为目标平台的硬件线程数量不同。让我们软件中的线程数量适应硬件。

虽然每个线程没有太多的内存开销，但是线程调度器管理它们是有开销的。如果我们只有 4 个核心，那么只有 4 个线程可以同时执行指令。即使我们的一些线程阻塞在 IO 上，我们仍然有大量空闲线程需要管理开销。

## 3. 线程数的最佳截止

我们需要能够将问题划分为可以同时完成的更小的作业，以利用并发性。如果问题包含无法分区的相当大的部分，则使问题并发可能不会产生太大的性能改进。

如果 IO 操作有更大的延迟，我们可能需要更多的线程来达到最佳点，因为更多的线程会更频繁地等待响应。相反，如果延迟较低，我只需要较少数量的线程即可实现最佳性能，因为等待时间会更少，因为每个线程的释放速度会更快。

受 CPU 限制的代码本质上受到 CPU 执行指令的速度的限制。因此，当我的代码同时运行在 4 个线程上时，我充分利用了我的 4 核 CPU 的处理能力而没有开销：

![最佳线程数](https://www.baeldung.com/wp-content/uploads/sites/4/2022/08/OptimumNumberOfThreads.png)

我们的应用程序在现实中可能并不那么简单。我们的应用程序可能在某些区域受 CPU 限制，而在其他区域受 IO 限制。我们的应用程序可能不受 IO 或 CPU 的限制。它可能受内存限制，或者根本不利用所有可用资源。

所有这些意味着管理我们创建的每个线程都会产生开销。更多线程并不总是意味着更快的创建。另一方面，增加这两个示例中的线程数可将性能提高 100% 到 600%。找到那个甜蜜点是值得的。

测量是获得确定答案的唯一途径。使用各种线程数运行我们的代码，评估结果并做出决定。如果不进行测量，我们可能永远无法得出“正确”的解决方案。找到理想的位置至关重要。这样做几次后，我们可能可以开始估计要使用的线程数，但最佳点会因 IO 工作负载或硬件而异。

负载下并发运行的最大线程数是我们应该密切关注的衡量指标。然后将第一个估计值提高 20% 作为安全边际。一旦遇到瓶颈，无论是 CPU、数据库、磁盘等，添加更多线程不会提高速度。但在我们到达那里之前，请继续添加线程。

## 4。总结

在本文中，我们讨论了服务器应该使用的良好线程数阈值。我们可以通过跨多个线程计数测量进程的性能来确定此阈值。要估计理想的截止值，或回答“多少个线程太多？”这个问题，应该测量和绘制性能并找到提供峰值性能的线程数。