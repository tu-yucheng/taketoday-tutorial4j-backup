## 1. 概述

当用户程序想要分配内存时，它要求 操作系统 (OS)通过执行系统调用来分配内存。这样，操作系统就可以正确地管理所有正在运行的进程之间的内存。

除此之外，操作系统还实现了 [虚拟内存](https://www.baeldung.com/cs/virtual-memory)，其主要目的是通过允许将内存的某些部分临时移动到硬盘驱动器中来扩展内存大小。

使用这种机制，给定的内存地址可能不在物理内存中。解决方案是使用虚拟地址而不是物理地址。

## 2.虚拟内存

虚拟内存的主要思想之一是 [分页](https://www.baeldung.com/cs/segmented-paging-vs-paged-segmentation)。它包括基本上将内存分成大小相同(通常为 4KB)的块，称为页面：

![物理内存页](https://www.baeldung.com/wp-content/uploads/sites/4/2022/02/imagem_2022-02-08_002300.png)

请注意，如果没有这种划分，我们至少需要相同数量的内存才能将所有物理地址映射到虚拟地址。相反，我们可以将页面的虚拟地址转换为物理地址，稍后我们将看到。

页的地址信息以及它们是存储在物理内存中还是硬盘驱动器中都保存在页表结构中。

每个页表条目 (PTE) 都包含指示该内存页在物理内存中的位置的信息：

![页表](https://www.baeldung.com/wp-content/uploads/sites/4/2022/02/page_table.png)

页表还提供了一些其他安全信息，例如关于拥有该内存页的进程的信息——因为一个进程不应该写入另一个进程的内存。但对于本文，我们只关注物理页面信息。

[内存管理单元 (MMU)](https://foldoc.org/memory+management+unit)是管理地址转换的硬件设备。该设备是 CPU 的一部分。另一方面，操作系统负责将页面移动到硬盘驱动器并将它们返回到 RAM。让我们看看它们在翻译过程中是如何相互作用的。

## 三、翻译过程

假设我们有一个程序(比方说，在 C 语言中)有一个简单的指令来为内存位置赋值，如下所示：

一 = 42;

我们要求操作系统运行我们的程序，它负责处理 CPU 的执行。当 CPU 读取这条指令时，它向 MMU 询问a的物理地址。

MMU 依次读取地址并提取指示页面编号的部分。有了这个虚拟页码，它会查询[转换后备缓冲区 (TLB)](https://developer.arm.com/documentation/den0013/d/The-Memory-Management-Unit/The-Translation-Lookaside-Buffer)以检索物理页码，该物理页码由缓存在 MMU 芯片内的页表的一部分组成，以实现性能优化。

如果在 TLB 中没有找到该页，则 MMU 会转到内存中的原始页表。获得页表条目后，MMU 可以转换物理地址，以便 CPU 可以访问该地址。

但是，如果该页面不存在于内存中怎么办？那么，在这种情况下，MMU 会引发一个页面错误异常，由操作系统处理，操作系统从硬盘驱动器检索该页面。当它发生时，操作系统使用[页面替换算法](https://www.baeldung.com/cs/fifo-page-replacement)来确定最近未使用的另一个页面，并且可以将其移出到硬盘驱动器。

现在让我们回到 MMU 可以转换地址的情况，看看转换是如何进行的。

## 4.翻译

回想上一节中的示例，我们想为变量a赋值 ，并假设其虚拟地址在 32 位系统中为 0x00018004(我们可以通过简单地打印 &a来查看)。

这个虚拟地址是分两部分读取的：一是页号，它是指向页表中某个PTE的指针，二是地址在该页内的偏移量。

一旦我们使用 4KB 页面大小，那么我们需要 12 位来寻址给定页面上的最新位置。所以偏移部分由虚拟地址中的前 12 位组成。

剩余的 20 位(在我们的 32 位系统中)用于指示页码。在这种情况下，我们最多可以有 1,048,576 个可能的页面。我们的虚拟地址看起来像这样：

![虚拟地址样本](https://www.baeldung.com/wp-content/uploads/sites/4/2022/02/imagem_2022-02-08_011812.png)

当 MMU 提取页码时，它获得值 0x00018 并从 TLB 中寻找该页条目。然后它发现它转换为物理页号 0x0020。

在这个例子中，偏移量部分是 0x004，它与物理页号相连，得到物理地址 0x0020004。我们可以看到虚拟地址的每一部分是如何被用来翻译成下面的物理地址的：

 

![将虚拟地址转换为物理地址](https://www.baeldung.com/wp-content/uploads/sites/4/2022/02/imagem_2022-02-08_125159.png)

## 5.总结

虚拟内存是一项重要功能，它允许系统将内存扩展到物理 RAM 之外，虚拟地址和物理地址之间的转换是该机制的关键。为使其高效发生，硬件 (MMU) 和软件 (OS) 协同工作。

翻译本身依赖于维护页表来跟踪内存中的虚拟和物理页面以及页面内每个地址的偏移量。

还必须注意的是，可能存在不同[类型的页表](https://en.wikipedia.org/wiki/Page_table#Page_table_types)，这些页表会根据系统实现它们的方式而有所不同。[在某些情况下，页表可能在目录中分层组织，并且可能需要对页目录](http://osr507doc.xinuos.com/en/OSAdminG/addr_trans.html)进行额外的 解析。