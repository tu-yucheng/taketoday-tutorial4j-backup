## 1. 概述

在本教程中，我们将了解操作系统 (OS) 中的虚拟内存概念。我们将研究构成创建虚拟内存的主要动机的问题。最后，我们将解释在操作系统中使用此功能的目的。

## 2.动机

计算机被设计成能够执行许多程序，每个程序处理不同数量的数据。操作系统有望利用更好的计算机资源，保证快速高效的处理。

三个主要问题导致处理在时间和消耗的内存方面变慢。由于我们在磁盘中以字节为单位存储数据，因此CPU在执行程序时必须将需要的数据加载到RAM中。

在执行时，操作系统允许程序使用 RAM 中特定范围的地址。假设这个空间是位，这意味着这里需要 (Exabyte)![64](https://www.baeldung.com/wp-content/ql-cache/quicklatex.com-77e3bd1a8e83fb5b49faa836a22738d2_l3.svg)的预期 RAM 大小。![2^{64} = 16EB](https://www.baeldung.com/wp-content/ql-cache/quicklatex.com-0ab00edf180fcf3c43798863538e5d51_l3.svg)

现在让我们假设操作系统已经保留了它的一部分 ( ![6GB](https://www.baeldung.com/wp-content/ql-cache/quicklatex.com-9fda803c926a8f50d8021ec039c00580_l3.svg))，但计算机的内存少于所需的 RAM。尝试使用超出范围的地址会使计算机崩溃。

此外，操作系统不可能拥有如此大的 RAM 容量：![不够](https://www.baeldung.com/wp-content/uploads/sites/4/2021/05/notenough.png)

当同时执行多个程序时，操作系统会为每个程序分配一个连续的 RAM 分区，以便同时处理它们。现在让我们假设两个程序完成了它们的执行。如果两个程序释放的空间不[连续](https://en.wikipedia.org/wiki/Continuous_memory)，不足以运行其他程序，那么RAM就会在不同的地方出现漏洞。这导致 [内存碎片](https://en.wikipedia.org/wiki/Fragmentation_(computing))：

![帐户](https://www.baeldung.com/wp-content/uploads/sites/4/2021/05/conti.png)

由于很多程序是同时执行的，所以不止一个程序可以访问同一块内存。为了改变它们的值，这些程序可能会相互冲突、破坏内存或使系统崩溃。下图显示了当多个程序访问时数据如何容易被破坏：![安全](https://www.baeldung.com/wp-content/uploads/sites/4/2021/05/security.png)

## 3. 虚拟内存介绍

虚拟内存是一种旨在通过使用辅助内存来解决内存物理短缺的技术，以便操作系统将其视为主内存的一部分。虚拟内存是临时内存。虚拟内存存储的大小取决于操作系统使用的寻址方案和可用的辅助内存。

虚拟内存将程序地址映射到 RAM 地址。如果没有更多可用空间，这些地址将被映射到磁盘中：

![捕获](https://www.baeldung.com/wp-content/uploads/sites/4/2021/05/Capture.png)

虚拟内存的主要优点是操作系统可以加载比其物理内存更大的程序。它给用户留下了计算机具有无限内存的印象。它还提供[内存保护](https://en.wikipedia.org/wiki/Memory_protection)。

为了实现映射操作，虚拟内存需要使用[页表和翻译](https://www.baeldung.com/cs/virtual-memory)。页表是一种存储页表的数据结构，称为页表项 (PTE)。页表的目标是将虚拟地址映射到物理地址。它是一个连续的块，是虚拟内存的最小单位。

创建内存页面包括将它们划分为[大小相等的帧](https://en.wikipedia.org/wiki/Page_(computer_memory))。每个帧指的是每个物理地址的帧号、帧偏移量或绝对地址。

翻译是使用页表将虚拟地址转换为物理地址的过程：![现在](https://www.baeldung.com/wp-content/uploads/sites/4/2021/05/pava.png)

为了使读取数据的过程更快，虚拟内存可以使用[缓存内存](https://en.wikipedia.org/wiki/CPU_cache)。由于物理缓存不能保证快速处理，因此我们使用虚拟缓存。CPU直接连接到缓存，它在其中查找虚拟地址，同时避免翻译。仅当未找到地址时才会进行转换。最终，每个程序都有自己的虚拟缓存：

![缓存 1](https://www.baeldung.com/wp-content/uploads/sites/4/2021/05/cache-1.png)

## 4. 为什么我们需要虚拟内存？

虚拟内存在现代操作系统中起着重要作用。本节将讨论操作系统需要使用虚拟内存的一些关键原因。

### 4.1. 内存空间问题

虚拟内存使共享代码变得容易；因此，我们不必保留相同代码的多个副本。使用虚拟内存，不同的虚拟地址可以映射到物理内存中的相同位置。因此，我们不必在主内存中存储相同代码的多个副本。

RAM 非常昂贵。因此，使用非常大的 RAM 并不是减轻任何存储分配需求的可行解决方案。为每个程序分配一个虚拟内存并将地址映射到磁盘消除了空间问题。

在二进制文件的情况下，当我们将它们加载到操作系统中时，每个函数都会在主内存中保留一个固定地址。如果虚拟内存不存在，我们就不能在主内存中加载多个程序。这意味着没有虚拟内存，我们一次只能运行一个程序。这是因为每个程序可能必须使用不同的函数，这些函数可能指向 RAM 中的相同地址。

### 4.2. 数据安全

另一个重要问题是数据安全。通常，一个程序可以猜测另一个程序的物理地址并获得对敏感和机密数据的访问权限。

如果一个操作系统使用虚拟内存技术，即使一些程序必须访问同一个地址，它们也有不同的映射。这确保它们将访问 RAM 或磁盘中的不同地址。这就是虚拟内存如何确保数据安全。

它还为数据提供位置独立性。我们可以将数据存储在主存的任何位置。

### 4.3. 内存碎片和错误

虚拟内存为每个程序提供了自己的映射。数据空间不必是连续的，每个程序都可以将数据存储在任何需要的地方。

它还有助于调试并提供用于检查各种功能的选项，例如未分配的内存和空指针。

假设两个或多个应用程序同时在操作系统中运行。所有这些应用程序都使用 RAM 的直接地址。如果其中一个应用程序在运行时出现错误，如[内存错误](https://en.wikipedia.org/wiki/Out_of_memory)，这可能会破坏并关闭其他应用程序。

某些物理设备(如视频 RAM)可能会预先保留一些内存地址，具体取决于计算机中使用的硬件。如果操作系统在不知道保留地址的情况下开始加载程序，则操作系统可能会读取和写入保留地址。这可能会导致插入的设备物理损坏。虚拟内存有助于操作系统避免这些问题。

## 5.总结

在本文中，我们详细讨论了虚拟内存。我们通过描述在操作系统中使用虚拟内存的一些动机来开始我们的讨论。然后我们给出了虚拟内存概念的一般概述。最后，我们解释了为什么我们需要操作系统中的虚拟内存。