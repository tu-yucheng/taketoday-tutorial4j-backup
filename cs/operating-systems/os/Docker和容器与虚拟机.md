## 1. 概述

在当今的部署和运营世界中，直接在我们的物理服务器上运行我们的服务是不寻常的。更常见的是，我们在虚拟主机(本地或云)或使用 Docker 等容器之间做出选择。

这种向更高抽象化的转变需要我们精通[基础架构即代码 (IaC)](https://www.redhat.com/en/topics/automation/what-is-infrastructure-as-code-iac)和容器编排，例如 Kubernetes。但是我们可以使用更小的步骤来实现一些优势。

在本教程中，我们将探索虚拟化和容器化。我们将比较技术差异和权衡。

## 2. 为什么要抽象？

在最简单的配置中，我们在已安装在服务器计算机上的操作系统(Linux、Windows 等)中托管应用程序和服务：

![基本部署](https://www.baeldung.com/wp-content/uploads/sites/4/2021/09/Basic-Deployment.png)

这在无数小型企业的服务器机房中仍然很常见。

然而，数据中心和云中的广泛虚拟化始于 2000 年代中期。以 Docker 为首的容器使用在 2010 年代中期标准化并获得了关注。

是什么继续推动这些技术的采用？

当我们以这种方式运行我们的服务时，我们获得了这些优势：

灵活性和可扩展性：如果我们需要扩展或缩小服务器的功能，我们可以轻松更改配置或将其到另一台主机。如果我们需要运行更多服务，我们可以启动更多虚拟机、云实例，或者向我们的 pod 添加容器。

资源利用：如果我们需要很多服务器来处理某事，但每月只需要一次，我们就不再需要让这些服务器在其余时间闲置。我们可以根据需要动态分配硬件(计算和存储)资源

进程隔离：我们可以将每个服务的代码、配置和依赖项分开，而不是跟踪安装在单一系统上的各种服务。这意味着我们不会通过更新另一件事来破坏一件事。此外，我们可以防止一个饥饿的应用程序减慢所有其他应用程序的速度

配置和变更管理：如果我们需要变更一个重要的系统，我们可以创建一个虚拟机的快照。如果事情变得非常错误，我们可以快速撤消我们的更改并且不会比以前更糟。此外，当我们一次处理一项服务时，记录配置和更改变得更加简单。当我们转向基础架构即代码，使用 Terraform 或 Ansible 等工具编写配置时，这些定义可帮助我们避免任何被遗忘或“暂时”的基础架构更改。

## 3. 虚拟化基础

虚拟化是指在软件中运行虚拟机。“主机”系统运行虚拟化软件，通常称为管理程序。“访客”系统在管理程序中运行。“来宾”操作系统几乎不知道它不是直接在硬件(“裸机”)上运行：

![虚拟化部署2](https://www.baeldung.com/wp-content/uploads/sites/4/2021/09/Virtualizied-Deployment2.png)

虚拟化软件的一些示例：

-   [Linux的KVM](https://www.linux-kvm.org/page/Main_Page)
-   VMware[工作站](https://www.vmware.com/products/workstation-player.html)或[ESXi](https://www.vmware.com/products/esxi-and-esx.html)
-   [Xen服务器](https://xenserver.org/)
-   [VirtualBox——](https://www.virtualbox.org/) 它是免费的，适合桌面使用
-   [DosBox](https://www.dosbox.com/) – 这是一款以老游戏而闻名的模拟器，但也能够运行完整的操作系统，例如 BeOS
-   微软的[Hyper-V](https://docs.microsoft.com/en-us/windows-server/virtualization/hyper-v/hyper-v-technology-overview)

我们可以使用这些工具来提供应用程序，例如 wiki 及其数据库，或网络监控套件。

我们还可以在我们的开发桌面上使用这些工具来安全地试验其他环境。

在 2000 年代中期，Intel 和 AMD 为其 CPU 添加了虚拟化扩展(Intel VT 和 AMD-V，或 SVM 模式)。这些是当今服务器的标准功能；但是，在台式机上，我们可能必须在 BIOS 设置中启用它们。这种硬件帮助极大地简化并加速了管理程序。

### 3.1. 虚拟机可以做什么？

当我们使用虚拟机映像而不是“裸机”服务器安装时，我们获得了可移植性。虚拟机映像是标准化的，因此我们可以根据需要轻松地将它们从一台主机移动到另一台主机。许多管理程序甚至支持实时迁移，其中虚拟机在从一台物理机无缝转移到另一台时继续运行。

AWS、GCP 和 Azure 等云服务提供的不仅仅是虚拟操作系统安装。但它们的基础在于虚拟机实例。我们不必自己去购买新硬件和安装 Ubuntu Server。我们可以只指定我们想要支付的 RAM 和 CPU 资源，要求特定的操作系统，然后我们就可以了。

与操作系统的任何完整安装一样，虚拟机必须启动并提供其所有功能。每个都可能运行完全不同的 Linux 内核或发行版。我们可能完全运行另一个操作系统，例如 Windows 或 BSD。这使我们的来宾彼此完全隔离，有助于提高安全性并简化配置和依赖关系。它也更重，占用更多空间和更多 CPU。

从用户的角度来看，虚拟机看起来与物理机完全一样。

## 4.容器基础

容器引擎(如 Docker)在完整的操作系统(如 Linux)上运行。操作系统提供内核和相关服务(文件系统、网络、进程管理)：

![容器部署](https://www.baeldung.com/wp-content/uploads/sites/4/2021/09/Container-Deployment.png)

容器提供运行特定服务所需的一切：

-   代码或应用程序二进制文件
-   库等依赖项
-   可能是解释器或运行时，例如 Python 或 JRE
-   配置和本地化，例如环境设置或用户帐户

所有这些元素都固定到特定版本。想想node的 package-lock.json 文件，或pip的 requirements.txt 文件：容器使用来自特定图像的命令和库。我们可以要求它使用图像中的最新版本，或者我们可以指定一个确切的版本。这样，当我们使用容器时，我们也指定了我们软件的环境(除了由主机操作系统确定的内核版本)。

### 4.1. Docker的作用

对于我们许多人来说，“ [Docker](https://www.docker.com/resources/what-container) ”和“容器”是同义词。虽然我们知道存在其他容器引擎(例如 Red Hat 的[Podman](https://podman.io/))，但我们可以从 Docker 生态系统中学习容器架构和使用的要点。

Docker 还[拥有一个巨大的容器镜像库](https://hub.docker.com/)，我们可以从中构建和运行我们自己的本地容器。

容器镜像就像我们正在运行的容器的模板一样工作。当容器运行时加载并运行它们时，它们就变成了容器。容器运行在我们使用的任何内核和操作系统之上，并添加所有其他需要的东西。它们通常建立在最小的源图像之上，例如流行的“ [alpine](https://hub.docker.com/_/alpine/) ”。

我们使用容器镜像的主要重点是捆绑特定的应用程序或服务及其所有相关依赖项。例如，我们可以[部署一个 Java WAR 存档及其服务器。](https://www.baeldung.com/docker-deploy-java-war)

在 docker 术语中，我们从 Docker Hub 拉取一个图像。然后我们在我们的容器引擎或运行时上本地运行它(containerd、Docker 的引擎和 CRI-O 是一些例子)。

### 4.2. 联合或覆盖文件系统

容器比虚拟机小得多。这意味着更少的存储空间，但也意味着近乎即时的启动时间。

如前所述，容器镜像可以选择性地仅包含其应用程序所需的操作系统元素。

它们体积小的另一个秘密在于它们如何不使用自己的单独文件系统，而是将元素分层到基础图像的元素上。基础保持只读状态，任何更改仅发生在容器内的本地层。

如果一个系统运行来自同一个基础镜像的容器，它只需要一个只读层的副本。节省更多空间！

### 4.3. 托管容器

我们可以使用容器来与我们的开发、测试和生产环境保持同步。不再是“但它可以在我的机器上运行！”

在生产中使用它们时，我们可以自己拉取、自定义和运行映像作为部署的一部分。但即使我们在云实例上执行此操作，它仍然会给我们留下大量的管理和操作工作。

云提供商支持直接使用我们的容器镜像。例如，[Amazon Fargate](https://aws.amazon.com/fargate/)接受一个图像并在一些资源配置后使其可用。

[Kubernetes](https://kubernetes.io/)是容器编排的事实标准，它为我们的容器化应用程序增加了高可用性和自我修复功能。它还增加了更多的复杂性。但是，虽然我们可能认为我们还不需要 k8s，但现在通过容器化我们的应用程序来准备它可以帮助我们为将来的扩展做好准备。

## 5.总结

虚拟机和容器解决了类似的问题。但是虚拟机这样做需要更多的开销、映像和为每个实例运行整个操作系统。

容器在单个操作系统下运行或通过编排在一个组中运行。它们提供易于替换的轻量级服务。

在本文中，我们将运行完整的虚拟机与在容器中运行我们的应用程序进行了比较。

虚拟机可能对长期安装更有用，这也需要灵活性。容器几乎适用于所有其他方面。