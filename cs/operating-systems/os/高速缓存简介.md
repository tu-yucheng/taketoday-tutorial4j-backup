## 1. 概述

缓存通常是内存的一小部分，战略性地分配到尽可能靠近特定硬件组件(例如 CPU)的位置。在这种情况下，缓存存储器被认为是快速的，以比其他主存储器(寄存器除外)更低的延迟提供要由 CPU 处理的数据。

在本教程中，我们将介绍高速缓存。首先，我们将一般性地研究计算机内存，特别注意内存层次结构。然后，我们将深入回顾缓存内存并了解缓存命中和缓存未命中的概念。最后，我们将了解 CPU 中的上下文切换通常如何影响高速缓存。

## 2. 计算机内存基础

目前，具有五级层次结构的金字塔组织计算机内存。金字塔中的每一层都会改变主要关于三个参数的记忆特性：

-   访问时间：从存储设备请求数据到接收所需数据之间经过的时间
-   存储容量：一个存储设备所能保存的最大数据量
-   每比特成本：与存储设备中可用的每一比特相关的平均货币成本

下图描绘了传统的计算机内存层次结构：

![记忆金字塔](https://www.baeldung.com/wp-content/uploads/sites/4/2021/09/MemoryPyramid-1536x968-1-1024x645.png)

首先，我们要了解主次记忆的概念，来分析记忆层次金字塔的每一层。主存储器最相关的特性是 CPU 直接访问它。相反，二级内存必须分配在主内存中才能被 CPU 访问。从本质上讲，主存储器是易失性的，而辅助存储器是非易失性的。但是，也有例外，例如初级和非易失性只读存储器 (ROM)。

### 2.1. 内存层次结构级别

在金字塔的顶端，我们有寄存器。 寄存器包含在 CPU 内部，因此与金字塔中的其他存储设备相比，访问时间最快。这些寄存器构成了 CPU 的存储单元。然而，存储单元与控制单元和算术逻辑单元共享CPU有限的物理空间。因此，这些装置必须经过精心设计和精确制造才能达到预期的性能。由于这些原因，寄存器通常代表内存中最小和最昂贵的部分。

在寄存器下方，我们有高速缓存。由于 CPU 内存单元的限制， 缓存提供靠近 CPU 的高速内存(有时在 CPU 芯片的特定位置)，通过专用数据总线连接到它。 一般来说，高速缓存比寄存器具有更大的存储容量并且速度更慢且更便宜。然而，与其他存储设备相比，它们仍然更快、更昂贵且存储量更少。

层次结构的第三层包括其他主要存储设备。这些设备最常见的例子是随机存取存储器 (RAM)，这是一种向 CPU 提供按需数据的易失性存储器。只读存储器 (ROM)、可编程只读存储器 (PROM) 和可擦除可编程只读存储器 (EPROM) 是该级别存储设备的其他示例。

在第四级，我们有固态辅助存储器，它可以包含非易失性闪存设备。这里一个突出的存储设备是固态驱动器 (SSD)。这些设备在不执行机械过程的情况下读取和写入数据。因此，它们通常比其他辅助存储设备更快、更节能且更昂贵。

其他辅助设备依次构成存储器层次结构的最后一级。这些设备的常见示例是硬盘、光盘和磁带。

## 3.缓存内存

从历史上看，内存速度不会像 CPU 速度那样发展。然而，随着技术的演进，CPU 工程师一直在努力提高处理速度，而不是增强或增加芯片中的寄存器数量。因此，内存工程师必须应对在 CPU 内存单元之外提供具有足够存储容量和合理成本的高速内存的挑战。

缓存是提供非常接近 CPU 的快速内存的替代方法，使用专用总线与其交换数据。通过这种方式，内存工程师使用不同的技术将小型高速内存(在这种情况下为寄存器加高速缓存)和大型慢速内存(其他主内存)相结合，以获得接近高速内存的一般速度和存储较慢内存的容量。

接下来，我们将看到有关高速缓存的相关概念和技术细节。

### 3.1. 局部性原则

从广义上讲，缓存尝试预测 CPU 将很快需要的指令和数据部分，从其他较慢的主内存设备加载它们。 该预测基于局部性原理。局部性原理考虑了 CPU 在一定时期内重复访问特定内存区域的趋势。因此，在这种情况下，该原则涉及时间和空间局部性：

-   Temporal locality ：假设缓存中最近加载的数据将在短时间内被多次重复使用。因此，在此期间不应从缓存中删除或替换此数据。
-   空间局部性：假设地址与最近加载的数据地址接近的数据很可能会在短期内被使用。因此，高速缓冲存储器应尽快加载这些相关数据。

### 3.2. 缓存层次结构

高速缓冲存储器本身呈现出特定的层次结构。例如，在最常见的场景中，计算机具有三个缓存级别，称为 L1、L2 和 L3：

-   L1 缓存：最快的缓存，存储容量最小(通常从 16KB 到 512KB)。L1 高速缓冲存储器与每个 CPU 核心的专用总线相连。在一些处理器中，这个缓存分为数据缓存和指令缓存。
-   L2缓存：访问速度比L1缓存稍慢的缓存。通常情况下，L2 缓存呈现 128KB 到 24MB 的存储容量。该高速缓存与 CPU 内核对之间共享的内存总线相连。
-   L3 缓存：目前缓存中访问速度最慢的缓存。一般来说，这个缓存的存储容量从2MB到32MB不等，它连接到多个CPU核心共享的内存总线。

除了呈现的高速缓存级别之外，特定的处理器(例如 Haswell 和 Broadwell)还具有 L4 高速缓存存储器。在这种情况下，L4 缓存连接到 CPU 和 GPU 之间共享的内存总线。

### 3.3. 缓存未命中和缓存命中

CPU 的核心在处理确定的任务时会多次访问内存。这些访问恢复 CPU 所需的指令和数据。必须强调的是，CPU 通常按照前面介绍的层次结构访问计算机内存，从较快的内存到较慢的内存。例如，如果需要的数据在L3缓存中，CPU首先访问L1和L2缓存不成功，最后在L3缓存中找到数据。因此，在这个小例子中，我们可以说发生了两次缓存未命中(L1 和 L2 缓存)和一次缓存命中(L3 缓存)：

-   缓存未命中：查找缓存以搜索特定数据或指令的事件，但它们 在访问的缓存内存中不可用。
-   缓存命中：查找缓存以搜索特定数据或指令的事件，并且它们 在访问的缓存内存中可用。在这种情况下，缓存返回请求的资源。

一般而言，我们可以说命中数与未命中数相比越多，高速缓存的性能就越好。在数学上，我们计算缓存未命中/命中率如下：

![Hit_{ratio} = frac{Hit_{total}}{Hit_{total} + Miss_{total}}](https://www.baeldung.com/wp-content/ql-cache/quicklatex.com-81097ece31d6fe56f5263a64ca98d886_l3.svg)

其中![命中_{总}](https://www.baeldung.com/wp-content/ql-cache/quicklatex.com-83286bc9006f7441e0b6982a8fd26eaa_l3.svg)和![小姐_{总}](https://www.baeldung.com/wp-content/ql-cache/quicklatex.com-ab0bbdc0b2dbf2972588da93b75118be_l3.svg)分别是一定时期内的缓存命中数和缓存未命中数。反过来![命中_{比率}](https://www.baeldung.com/wp-content/ql-cache/quicklatex.com-2e321a5bb4e8d92e19e5f0b52b5aeb4f_l3.svg)，范围介于 0 和 1 之间，越接近 1，缓存性能越好。

请注意，相同的缓存(就硬件而言)处理相同的数据/信息请求可能具有不同的性能。例如，由于采用了不同的[缓存写入策略](https://www.baeldung.com/cs/cache-write-policy)，会出现这种差异。

### 3.4. 上下文切换

在多任务计算机中，多个进程共享 CPU 执行时间。在一般情况下，CPU 中的内核数量远少于计算机中执行的进程数量。所以，CPU以间隔的方式调度这些进程的执行。因此，实际上，上下文切换包括中断在 CPU 内核中执行的进程以执行新进程或先前中断的进程。

一个进程在一个CPU内核中执行时，可能会需要多个数据和指令，我们称之为进程工作集。最终，缓存内存将加载整个或部分进程的工作集。然而，在上下文切换之后，缓存通常是干净的或包含先前执行的进程的工作集。因此，由于上下文切换，几个缓存未命中通常发生在 CPU 内核中进程执行的开始。

最后，重要的是要注意，根据所使用的缓存内存的存储容量、写入策略和进程施加的内存工作负载，上下文切换导致的缓存未命中可能或多或少严重。

## 4。总结

在本文中，我们研究了高速缓存。首先，我们回顾了计算机内存的基本概念。接下来，我们深入分析缓存内存。然后，我们了解了缓存存储器的工作原理以及它们的不同类别。最后，我们概述了 CPU 内核中的上下文切换如何影响缓存命中和未命中。

我们可以得出总结，缓存是当前计算机的重要存储设备。通过使用不同的技术和分层结构，高速缓存允许快速有效地访问计算机内存，减少 CPU 因进程等待数据或指令而闲置。