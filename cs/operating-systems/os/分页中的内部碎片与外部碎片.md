## 1. 概述

在本教程中，我们将首先讨论负责操作系统内存管理的分页技术。然后，我们将 介绍碎片问题及其两个变体。最后，我们将讨论两种碎片化变体之间的核心差异。

最后，我们将解释为什么在分页中只发生内部碎片。

## 2. 分页简介

分页允许我们将内存中的进程存储在一个不连续的空间中。为实现此技术，我们将进程划分为[页面](https://en.wikipedia.org/wiki/Page_(computer_memory))。页面是固定大小的块。同样，我们也将物理内存划分为帧。

在执行进程时，CPU 将每个页面的[逻辑地址](https://en.wikipedia.org/wiki/Logical_address)转换为[物理地址](https://en.wikipedia.org/wiki/Physical_address)。然后，使用[分段分页](https://www.baeldung.com/cs/segmented-paging-vs-paged-segmentation)技术，我们将 CPU 提供的地址划分为页号和页偏移量。

如果[虚拟地址](https://www.baeldung.com/cs/virtual-memory)很大，页面在分页时会占用很大的实际内存空间。复杂的程序往往很大并且占用大量内存。因此，通过分页管理主内存对于操作系统来说是一项艰巨的任务。

尽管分页解决了外部碎片问题，但内部碎片仍然是分页的主要缺陷之一。现在要理解为什么分页中没有外部碎片，我们需要详细了解这两种碎片。

### 2.1. 物理地址计算

要将逻辑地址转换为卷地址，我们需要知道页码。[我们可以在页表](https://en.wikipedia.org/wiki/Page_table)中找到与逻辑地址关联的页码。我们还在那里存储每个页面的物理地址。现在为了得到物理地址，我们提取对应的实际页面地址并将它们添加到偏移量中：

![PG](https://www.baeldung.com/wp-content/uploads/sites/4/2021/10/pg.png)

### 2.2. 例子

假设我们将一个进程分为三个页面：A、B、C。每个进程对应的页面都有一个页码(A，5)，(B，6)，(C，7)与之关联。现在要在页表中查找页，CPU 使用与页关联的页码。[段表](https://en.wikipedia.org/wiki/Memory_segmentation)存储每一页的页码和帧号。

CPU从段表中提取每一页的帧号，在物理内存中找到它们。偏移量有助于找到已经确定的帧的大小：

![pgex](https://www.baeldung.com/wp-content/uploads/sites/4/2021/10/pgex.png)

## 三、分片及其变体

当我们将内存分成小块时，就会发生碎片。此外，碎片在本质上是不连续的。因此，我们不能将它们分配给进程。结果，当进程在队列中挂起并等待内存时，内存将有多个未使用的块。碎片可以是内部的，也可以是外部的。

当我们将物理内存拆分为连续的已安装大小的块并为可能大于请求的内存的进程分配内存时，就会发生内部碎片。因此，未使用的分配空间被保留下来，不能被其他进程使用。[最适合块搜索](https://en.wikipedia.org/wiki/Fragmentation_(computing))是内部碎片的解决方案。

当未使用的内存空间总量足以回答所有分配请求时，就会发生外部碎片。这里的内存是不连续的。因此，内存中到处都是空块，不足以分配给其他程序。[压缩](https://en.wikipedia.org/wiki/Fragmentation_(computing))是外部碎片的解决方案。

## 4. 内部碎片和外部碎片的区别

下面说说这两种分片的主要区别：

![由 QuickLaTeX.com 呈现](https://www.baeldung.com/wp-content/ql-cache/quicklatex.com-8ba55f38127c53b40a92c8f8e1739980_l3.svg)

## 5. 为什么分页会导致内部碎片？

我们已经知道分页将程序分成固定大小的页面。然而，在某些时候，程序可能不需要精确的整个页面。因此，它可以留下内存的空闲分区，从而导致内存分配有未使用的空间。这正是内存中发生内部碎片的方式。

让我们举个例子。我们正在采用一个程序，该程序被分成两个大小相等的块，每个块大小为 2KB。因此，我们在内存中分配了 4KB 的非连续空间。但是，如果一个程序只需要 3KB，那么内存中会留下一个已分配但未使用的 1KB 空间，从而导致内部碎片：

![在](https://www.baeldung.com/wp-content/uploads/sites/4/2021/10/in-1536x1180-1-1024x787.png)

这里有两个 2KB 的块。但是，该程序使用了第一个块中的 1.7KB 和第二个块中的 1.3KB。因此，两个块上都留下了两个已分配但未使用的小内存块。我们不能使用这些内存块来分配其他程序。因此，分页的工作方式使其非常容易受到内部碎片的影响。

## 6. 分页会产生外部碎片吗？

在将程序划分为固定大小的页面时，我们也将物理内存划分为大小相等的帧。这种技术的特殊性在于为程序分配的空间是不连续的。因此，当其他进程不分配非连续块时，它们可以被其他程序使用。分页允许它们使用非连续的内存块。

让我们举个例子。首先，我们将一个程序分成两个不连续的固定大小的块。然后，任何其他程序都可以使用未分配的剩余块：

![前任](https://www.baeldung.com/wp-content/uploads/sites/4/2021/10/ex-1536x1186-1-1024x791.png)

这里程序 A 从两个不连续的固定大小的块中分配一些空间。但是，块中还有一些空间。现在因为内存是不连续的，所以程序 B 可以从块中获取剩余空间。因此，分页中出现外部碎片的可能性要小得多。

现在让我们将外部和内部碎片示例合并为一个，这样我们就可以清楚地了解：

![指数](https://www.baeldung.com/wp-content/uploads/sites/4/2021/10/inex-1536x1171-1-1024x781.png)

## 七、总结

在本教程中，我们讨论了碎片及其变体：内部碎片和外部碎片。我们还解释了为什么分页更容易受到内部碎片的影响。